{% extends "base.html" %}
{% load static %}

{% block title %}Analysis{% endblock %}

{% block content %}

<!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—  -left-fullã§åˆæœŸã¯ç”»é¢å¤–ã«å‡ºã—ã¦ãŠã -->
<div id="hover-tooltip" class="fixed -left-full pointer-events-none transition-opacity duration-200 z-50 bg-gray-800 text-white text-[10px] py-1.5 px-3 rounded shadow-xl whitespace-nowrap">
  ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
</div>

<!-- ãƒœãƒƒã‚¯ã‚¹å…¨ä½“ -->
<div class="min-h-screen py-10 px-4 space-y-6">
  <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-lg">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å¸¯ -->
    <div class="bg-teamy-navy px-6 py-1 rounded-t-lg flex justify-between items-center">
      <div class="flex items-center gap-3 m-2">

        <!-- ãƒãƒ¼ãƒ é¸æŠã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º -->
        <h1 class="text-white text-xl font-bold tracking-wider flex items-center gap-2">
        <div class="relative">
            <select id="team-select" class="bg-white/10 text-white text-2xl rounded px-3 py-1 pr-8 appearance-none cursor-pointer hover:bg-white/20 transition-all focus:outline-none">
            <option value="" class="text-teamy-grayDark">ãƒãƒ¼ãƒ ã‚’é¸æŠ</option>
            {% for team in teams %}
                <option value="{{ team.id }}" class="text-gray-800" {% if team.id == team_id %}selected{% endif %}>
                {{ team.name }}
                </option>
            {% endfor %}
            </select>
            
            <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-white/70">
            <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
            </svg>
            </div>
        </div>
        <span>ã¨ {{ user_name }} ã•ã‚“ã®ä¾¡å€¤è¦³</span>
        </h1>

        <!-- [ï¼Ÿ]ãƒ˜ãƒ«ãƒ—ãƒªãƒ³ã‚¯ -->
        <button type="button" class="btn-help h-6 w-6">
          <img src="{% static 'imgs/help.png' %}" alt="ã¸ãƒ«ãƒ—ã‚’è¡¨ç¤º">
        </button>
      </div>

        <!-- ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ†æãƒœã‚¿ãƒ³ -->
        {% if is_team_leader %}
        <a href="{% url 'analysis:managers_page' %}?team_id={{ team_id }}" 
          class="self-center inline-block bg-teamy-teal hover:bg-teamy-tealDark hover:scale-[1.03] active:scale-[0.98] transition-transform text-white font-semibold px-6 py-2 rounded-full shadow-md text-sm">
          ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å‘ã‘åˆ†æã¸
        </a>
       {% endif %}
    </div>

    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="p-8">
      <div class="flex border-b border-gray-100 mb-4 gap-8">
        <button id="tab-me-btn" class="px-6 py-2 text-gray-400 font-bold">ã‚ãªãŸã®ä¾¡å€¤è¦³</button>
        <button id="tab-team-btn" class="px-6 py-2 text-teamy-teal font-bold border-b-2 border-teamy-teal -mb-[1px]">ãƒãƒ¼ãƒ ã¨ã®æ¯”è¼ƒ</button>
      </div>

      <!-- ã‚ãªãŸã®ä¾¡å€¤è¦³ãƒšãƒ¼ã‚¸ -->
      <div id="content-me">
          {% include "analysis/includes/personal_me.html" %}
      </div>
      <!-- ãƒãƒ¼ãƒ ã¨ã®æ¯”è¼ƒãƒšãƒ¼ã‚¸ -->
      <div id="content-team" class="hidden relative min-h-[400px]">
        {% if teams %}
          {% include "analysis/includes/personal_team.html" %}
        {% else %}
        <div class="absolute inset-0 z-30 bg-teamy-grayDark/60 rounded-xl flex justify-center items-center">
          <div class="text-center p-8 bg-teamy-grayLight rounded-2xl -translate-y-48">
            <p class="text-teamy-grayText leading-relaxed">
              ãƒãƒ¼ãƒ ã«æ‰€å±ã™ã‚‹ã“ã¨ã§<br>
              çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
          </div>
        </div>
          <div class="opacity-20 grayscale pointer-events-none">
            {% include "analysis/includes/personal_team.html" %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
{{ graph_data|json_script:"personal-graph-data" }}
{{ advice_data|json_script:"personal-advice-data" }}

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
{% include "analysis/modals/analysis_guide.html" %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'analysis/personal_analysis.js' %}"></script>

<!-- ä»¥ä¸‹ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰ å‰Šé™¤äºˆå®š -->
<script>
window.addEventListener('load', () => {
    // --- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å®šç¾© ---
    const testData = {
        personalScore: 20,
        teamMean: 85,
        importance: 'high', // 'high', 'middle', 'low' ã§åˆ‡ã‚Šæ›¿ãˆ
        advice: "ã“ã®ä¾¡å€¤è¦³ã¯ã€ã‚ãªãŸãŒæ„è­˜çš„ã«æ­©ã¿å¯„ã‚‰ãªã„ã¨æ‘©æ“¦ãŒèµ·ãã‚„ã™ã„çŠ¶æ³ã§ã™ã€‚\nç›¸æ‰‹ã®ç™ºè¨€ã‚’ã€Œäº‹å®Ÿã€ã§ã¯ãªãã€Œæ„å›³ã€ã ã¨ä»®å®šã—ã¦èãã¾ã—ã‚‡ã†ã€‚\nã™ãçµè«–ã‚’å‡ºã•ãšã€ã€Œãã‚Œã£ã¦ã€ã©ã†ã„ã†æ„å‘³ï¼Ÿã€ã€Œä¸€ç•ªä¼ãˆãŸã„ã®ã¯ã©ã“ï¼Ÿã€ã¨ç¢ºèªã®è³ªå•ã‚’å¢—ã‚„ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚\nè‡ªåˆ†ã®ç™ºè¨€é‡ã‚’å°‘ã—æ¸›ã‚‰ã—ã€ç›¸æ‰‹ã®è©±ã‚’æœ€å¾Œã¾ã§èãè¡¨æƒ…ãƒ»é–“ãƒ»å£°ã®ãƒˆãƒ¼ãƒ³ãªã©ã€è¨€è‘‰ä»¥å¤–ã®æƒ…å ±ã‚’æ„è­˜çš„ã«æ‹¾ã„ã¾ã—ã‚‡ã†ã€‚\nãƒã‚¤ãƒ³ãƒˆï¼šã€Œç›¸æ‰‹ã¯ä¸è¦ªåˆ‡ãªã®ã§ã¯ãªãã€å‰æã‚’å…±æœ‰ã—ã¦è©±ã—ã¦ã„ã‚‹ã ã‘ã€ã¨è€ƒãˆã¾ã—ã‚‡ã†ã€‚"
    };

    // --- 1è¡Œç›®ï¼ˆæœ€åˆã® analysis-rowï¼‰ã‚’å–å¾— ---
    const firstRow = document.querySelector('.analysis-row');
    if (firstRow) {
        // --- ãƒ”ãƒ³ã®ä½ç½®ã‚’ä¸Šæ›¸ã ---
        const userPin = firstRow.querySelector('.user-pin');
        const teamPin = firstRow.querySelector('.team-pin');
        if (userPin) {
            userPin.style.left = testData.personalScore + '%';
            userPin.style.transform = "translateX(-50%)";
        }
        if (teamPin) {
            teamPin.style.left = testData.teamMean + '%';
            teamPin.style.transform = "translateX(-50%)";
        }

        // --- é‡è¦åº¦ãƒãƒƒã‚¸ï¼ˆè‰²ã¨æ–‡å­—ï¼‰ã‚’ä¸Šæ›¸ã ---
        const badge = firstRow.querySelector('.w-10.h-10');
        if (badge) {
            // ã‚¯ãƒ©ã‚¹ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
            badge.classList.remove('bg-teamy-pinkRed', 'bg-teamy-teal', 'bg-teamy-navy');
            
            if (testData.importance === 'high') {
                badge.classList.add('bg-teamy-pinkRed');
                badge.innerText = 'é«˜';
            } else if (testData.importance === 'middle') {
                badge.classList.add('bg-teamy-teal');
                badge.innerText = 'ä¸­';
            } else {
                badge.classList.add('bg-teamy-navy');
                badge.innerText = 'ä½';
            }
        }

        // --- ã‚¢ãƒ‰ãƒã‚¤ã‚¹æœ¬æ–‡ã‚’ä¸Šæ›¸ã ---
        // detailsã‚¿ã‚°ã®ä¸­ã«ã‚ã‚‹ã€æœ¬æ–‡ãŒå…¥ã‚‹divã‚’æ¢ã™
        const details = firstRow.closest('details');
        const adviceBox = details.querySelector('.mt-4.p-4');
        if (adviceBox) {
            adviceBox.innerText = testData.advice;
        }

        console.log("Full Test Data Applied!");
    }
});
</script>

{% endblock %}