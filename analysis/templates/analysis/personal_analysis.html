{% extends "base.html" %}
{% load static %}

{% block title %}Analysis{% endblock %}

{% block content %}

<!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—  -left-fullã§åˆæœŸã¯ç”»é¢å¤–ã«å‡ºã—ã¦ãŠã -->
<div id="hover-tooltip" class="fixed -left-full pointer-events-none transition-opacity duration-200 z-50 bg-gray-800 text-white text-[10px] py-1.5 px-3 rounded shadow-xl whitespace-nowrap">
  ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
</div>

<div class="min-h-screen py-10 px-4 space-y-6">
  <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">
    
    <div class="bg-teamy-navy px-6 py-1 flex justify-between items-center">
      <h1 class="text-white text-xl font-bold tracking-wider">{{ user_name }} ã•ã‚“ã¨ {{ team_name }} ã®ä¾¡å€¤è¦³</h1>
      <div class="flex flex-col items-center gap-2 m-2">

        {% if is_team_leader %}
        <a href="{% url 'analysis:managers_page' %}?team_id={{ team_id }}" class="self-center inline-block bg-teamy-teal hover:bg-teamy-tealDark hover:scale-[1.03] active:scale-[0.98] transition-transform text-white font-semibold px-6 py-2 rounded-full shadow-md text-sm">
          ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å‘ã‘åˆ†æã¸
        </a>
        {% endif %}
      </div>
    </div>

    <div class="p-8">
      <div class="flex border-b border-gray-100 mb-8 gap-8">
        <button id="tab-me-btn" class="px-6 py-2 text-gray-400 font-bold">ã‚ãªãŸã®ä¾¡å€¤è¦³</button>
        <button id="tab-team-btn" class="px-6 py-2 text-teamy-teal font-bold border-b-2 border-teamy-teal -mb-[1px]">ãƒãƒ¼ãƒ ã¨ã®æ¯”è¼ƒ</button>
      </div>

      <!-- ã‚ãªãŸã®ä¾¡å€¤è¦³ -->
      <div id="content-me">
          {% include "analysis/includes/personal_me.html" %}
      </div>
      <!-- ãƒãƒ¼ãƒ ã¨ã®æ¯”è¼ƒ -->
      <div id="content-team" class="hidden">
          {% include "analysis/includes/personal_team.html" %}
      </div>
    </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
{{ graph_data|json_script:"personal-graph-data" }}
{{ advice_data|json_script:"personal-advice-data" }}

{% endblock %}

{% block extra_js %}
<script src="{% static 'analysis/personal_analysis.js' %}"></script>

<script>
window.addEventListener('load', () => {
    // --- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å®šç¾© ---
    const testData = {
        userScore: 20,
        teamScore: 85,
        importance: 'high', // 'high', 'middle', 'low' ã§åˆ‡ã‚Šæ›¿ãˆ
        advice: "ã“ã®ä¾¡å€¤è¦³ã¯ã€ã‚ãªãŸãŒæ„è­˜çš„ã«æ­©ã¿å¯„ã‚‰ãªã„ã¨æ‘©æ“¦ãŒèµ·ãã‚„ã™ã„çŠ¶æ³ã§ã™ã€‚\nç›¸æ‰‹ã®ç™ºè¨€ã‚’ã€Œäº‹å®Ÿã€ã§ã¯ãªãã€Œæ„å›³ã€ã ã¨ä»®å®šã—ã¦èãã¾ã—ã‚‡ã†ã€‚\nã™ãçµè«–ã‚’å‡ºã•ãšã€ã€Œãã‚Œã£ã¦ã€ã©ã†ã„ã†æ„å‘³ï¼Ÿã€ã€Œä¸€ç•ªä¼ãˆãŸã„ã®ã¯ã©ã“ï¼Ÿã€ã¨ç¢ºèªã®è³ªå•ã‚’å¢—ã‚„ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚\nè‡ªåˆ†ã®ç™ºè¨€é‡ã‚’å°‘ã—æ¸›ã‚‰ã—ã€ç›¸æ‰‹ã®è©±ã‚’æœ€å¾Œã¾ã§èãè¡¨æƒ…ãƒ»é–“ãƒ»å£°ã®ãƒˆãƒ¼ãƒ³ãªã©ã€è¨€è‘‰ä»¥å¤–ã®æƒ…å ±ã‚’æ„è­˜çš„ã«æ‹¾ã„ã¾ã—ã‚‡ã†ã€‚\nãƒã‚¤ãƒ³ãƒˆï¼šã€Œç›¸æ‰‹ã¯ä¸è¦ªåˆ‡ãªã®ã§ã¯ãªãã€å‰æã‚’å…±æœ‰ã—ã¦è©±ã—ã¦ã„ã‚‹ã ã‘ã€ã¨è€ƒãˆã¾ã—ã‚‡ã†ã€‚"
    };

    // --- 1è¡Œç›®ï¼ˆæœ€åˆã® analysis-rowï¼‰ã‚’å–å¾— ---
    const firstRow = document.querySelector('.analysis-row');
    if (firstRow) {
        // --- ãƒ”ãƒ³ã®ä½ç½®ã‚’ä¸Šæ›¸ã ---
        const userPin = firstRow.querySelector('.user-pin');
        const teamPin = firstRow.querySelector('.team-pin');
        if (userPin) {
            userPin.style.left = testData.userScore + '%';
            userPin.style.transform = "translateX(-50%)";
        }
        if (teamPin) {
            teamPin.style.left = testData.teamScore + '%';
            teamPin.style.transform = "translateX(-50%)";
        }

        // --- é‡è¦åº¦ãƒãƒƒã‚¸ï¼ˆè‰²ã¨æ–‡å­—ï¼‰ã‚’ä¸Šæ›¸ã ---
        const badge = firstRow.querySelector('.w-10.h-10');
        if (badge) {
            // ã‚¯ãƒ©ã‚¹ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
            badge.classList.remove('bg-teamy-pinkRed', 'bg-teamy-teal', 'bg-teamy-navy');
            
            if (testData.importance === 'high') {
                badge.classList.add('bg-teamy-pinkRed');
                badge.innerText = 'é«˜';
            } else if (testData.importance === 'middle') {
                badge.classList.add('bg-teamy-teal');
                badge.innerText = 'ä¸­';
            } else {
                badge.classList.add('bg-teamy-navy');
                badge.innerText = 'ä½';
            }
        }

        // --- ã‚¢ãƒ‰ãƒã‚¤ã‚¹æœ¬æ–‡ã‚’ä¸Šæ›¸ã ---
        // detailsã‚¿ã‚°ã®ä¸­ã«ã‚ã‚‹ã€æœ¬æ–‡ãŒå…¥ã‚‹divã‚’æ¢ã™
        const details = firstRow.closest('details');
        const adviceBox = details.querySelector('.mt-4.p-4');
        if (adviceBox) {
            adviceBox.innerText = testData.advice;
        }

        console.log("Full Test Data Applied!");
    }
});
</script>

{% endblock %}